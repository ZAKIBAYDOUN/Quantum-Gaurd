name: codesign-dryrun
on:
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest
    env:
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_LINK_BASE64: ${{ secrets.CSC_LINK_BASE64 }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - name: Setup Code Signing (Windows)
        if: env.CSC_LINK != '' || env.CSC_LINK_BASE4 != '' || env.CSC_LINK_BASE64 != ''
        shell: pwsh
        run: |
          $b64 = $env:CSC_LINK
          if ($b64 -and $b64.StartsWith('base64:')) { $b64 = $b64.Substring(7) }
          elseif ($env:CSC_LINK_BASE64) { $b64 = $env:CSC_LINK_BASE64 }
          if ($b64) {
            $path = Join-Path $env:RUNNER_TEMP 'signing.pfx'
            [IO.File]::WriteAllBytes($path, [Convert]::FromBase64String($b64))
            "CSC_LINK=$path" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          }
      - run: npm install --no-audit --no-fund
      - run: npx electron-builder --win nsis --publish never
      - name: Verify signature
        shell: pwsh
        run: |
          Get-ChildItem dist -Filter *.exe | ForEach-Object {
            Write-Host "Verifying $_"; Get-AuthenticodeSignature $_.FullName | Format-List
          }
      - uses: actions/upload-artifact@v4
        with:
          name: win-signed-artifacts
          path: dist/*.exe